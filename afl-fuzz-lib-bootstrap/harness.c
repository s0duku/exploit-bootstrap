#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <assert.h>
#include <dlfcn.h>
#include <unistd.h>

FILE * fuzz_log_fp = NULL;
bool fuzz_log_assert = true;

#define LOG_OPEN() fuzz_log_fp=fopen(FUZZ_LOG_PATH,"w");assert(fuzz_log_fp != NULL);
#define LOG_OUT(log) fwrite(log,sizeof(char),strlen(log),fuzz_log_fp);fwrite("\r\n",sizeof(char),strlen("\r\n"),fuzz_log_fp);puts(log);
#define LOG_CLOSE() fclose(fuzz_log_fp);
#define LOG_ASSERT(expr) fuzz_log_assert=expr;if(!fuzz_log_assert){LOG_OUT("Assert Failed! '"#expr"'");LOG_CLOSE();abort();} 






typedef void * (*fuzz_func_t)(char *);

void *fuzz_lib_handle = NULL;
fuzz_func_t fuzz_func = NULL;
#define FUZZ_LIB_PATH "FUZZ_LIB_PATH"
#define FUZZ_LIB_FUNC_NAME "FUZZ_LIB_FUNC_NAME"


char fuzz_input_buf[FUZZ_INPUT_BUF_SIZE] = {0};


#ifdef CALL_FUZZ_FUNC

void call_fuzz_func(){
	unsigned int fuzz_input_len = 0;
	memset(fuzz_input_buf, 0, sizeof(fuzz_input_buf));
	fuzz_input_len = read(0,fuzz_input_buf,sizeof(fuzz_input_buf));

	// TODO: call your taget function here
	fuzz_func(fuzz_input_buf);
}

#elif TEST_FUZZ_FUNC

void test_fuzz_func(){
	// TODO: test whether target function loads correctly
	fuzz_func("test");
}

#endif


void init_fuzz_func(){
	// TODO: init the targe function from lib
	LOG_OPEN();
	LOG_ASSERT(getenv(FUZZ_LIB_PATH) != NULL);
	LOG_ASSERT(getenv(FUZZ_LIB_FUNC_NAME) != NULL);

	printf("\tLoad Shared Library: %s\n",getenv(FUZZ_LIB_PATH));

	fuzz_lib_handle = dlopen(getenv(FUZZ_LIB_PATH),RTLD_LAZY);
	
	if(fuzz_lib_handle == NULL){
		LOG_OUT(dlerror());
		abort();
	}

	printf("\tFuzz Target Function: %s\n",getenv(FUZZ_LIB_FUNC_NAME));

	fuzz_func = dlsym(fuzz_lib_handle,getenv(FUZZ_LIB_FUNC_NAME));
	LOG_ASSERT(fuzz_func != NULL);
	LOG_CLOSE();
}

int main(int argc, char **argv){

	puts("");
	#ifdef FUZZ_ARCH_X86
	printf("Use Input Buf Size 0x%x\n",sizeof(fuzz_input_buf));
	#elif FUZZ_ARCH_X64
	printf("Use Input Buf Size 0x%lx\n",sizeof(fuzz_input_buf));
	#endif
	puts("Start Init Fuzz Function");
		init_fuzz_func();
	puts("End Init Fuzz Function");

	puts("");

	#ifdef CALL_FUZZ_FUNC
	puts("Start Call Fuzz Function");
		call_fuzz_func();
	puts("End Call Fuzz Function");
	#elif TEST_FUZZ_FUNC
	puts("Start Test Fuzz Function");
		test_fuzz_func();
	puts("End Test Fuzz Function");
	#endif

	puts("");

	return 0;
}
