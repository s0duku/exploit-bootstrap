#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <dlfcn.h>
#include <unistd.h>


typedef void * __attribute__((__fastcall__))(*fuzz_func_t)(char *);

void *fuzz_lib_handle = NULL;
fuzz_func_t fuzz_func = NULL;
#define FUZZ_LIB_PATH "FUZZ_LIB_PATH"
#define FUZZ_LIB_FUNC_NAME "FUZZ_LIB_FUNC_NAME"


char fuzz_input_buf[FUZZ_INPUT_BUF_SIZE] = {0};


#ifdef CALL_FUZZ_FUNC

void call_fuzz_func(){
	unsigned int fuzz_input_len = 0;
	memset(fuzz_input_buf, 0, sizeof(fuzz_input_buf));
	fuzz_input_len = read(0,fuzz_input_buf,sizeof(fuzz_input_buf));

	// TODO: call your taget function here
	fuzz_func(fuzz_input_buf);
}

#elif TEST_FUZZ_FUNC

void test_fuzz_func(){
	// TODO: test whether target function loads correctly
	fuzz_func("test");
}

#endif


void init_fuzz_func(){
	// TODO: init the targe function from lib

	assert(getenv(FUZZ_LIB_PATH) != NULL);
	assert(getenv(FUZZ_LIB_FUNC_NAME) != NULL);

	printf("\tLoad Shared Library: %s\n",getenv(FUZZ_LIB_PATH));

	fuzz_lib_handle = dlopen(getenv(FUZZ_LIB_PATH),RTLD_LAZY);
	
	if(fuzz_lib_handle == NULL){
		puts(dlerror());
		abort();
	}

	printf("\tFuzz Target Function: %s\n",getenv(FUZZ_LIB_FUNC_NAME));

	fuzz_func = dlsym(fuzz_lib_handle,getenv(FUZZ_LIB_FUNC_NAME));
	assert(fuzz_func != NULL);
}

int main(int argc, char **argv){

	puts("");
	printf("Use Input Buf Size 0x%lx\n",sizeof(fuzz_input_buf));
	puts("Start Init Fuzz Function");
		init_fuzz_func();
	puts("End Init Fuzz Function");

	puts("");

	#ifdef CALL_FUZZ_FUNC
	puts("Start Call Fuzz Function");
		call_fuzz_func();
	puts("End Call Fuzz Function");
	#elif TEST_FUZZ_FUNC
	puts("Start Test Fuzz Function");
		test_fuzz_func();
	puts("End Test Fuzz Function");
	#endif

	puts("");

	return 0;
}
